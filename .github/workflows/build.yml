name: Build Artifacts

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

permissions:
  contents: read
  actions: read
  packages: read

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: windows-latest
            python: '3.11'
            mode: standalone
            spec: SBY_OST_Tool.spec
            artifact-name: sby-ost-tool-windows-standalone
            dist-path: dist/SBY_OST_Tool
            archive-name: SBY_OST_Tool-windows-standalone.zip
          - os: windows-latest
            python: '3.11'
            mode: streaming
            spec: SBY_OST_Tool_Remote.spec
            artifact-name: sby-ost-tool-windows-streaming
            dist-path: dist/SBY_OST_Tool_Remote
            archive-name: SBY_OST_Tool-windows-streaming.zip
          - os: ubuntu-latest
            python: '3.11'
            mode: standalone
            spec: SBY_OST_Tool_Linux.spec
            artifact-name: sby-ost-tool-linux-standalone
            dist-path: dist/SBY_OST_Tool
            archive-name: SBY_OST_Tool-linux-standalone.tar.gz
          - os: ubuntu-latest
            python: '3.11'
            mode: streaming
            spec: SBY_OST_Tool_Remote_Linux.spec
            artifact-name: sby-ost-tool-linux-streaming
            dist-path: dist/SBY_OST_Tool_Remote
            archive-name: SBY_OST_Tool-linux-streaming.tar.gz
          - os: macos-latest
            python: '3.11'
            mode: standalone
            spec: SBY_OST_Tool_Mac.spec
            artifact-name: sby-ost-tool-macos-standalone
            dist-path: dist/SBY_OST_Tool.app
            archive-name: SBY_OST_Tool-macos-standalone.zip
          - os: macos-latest
            python: '3.11'
            mode: streaming
            spec: SBY_OST_Tool_Remote_Mac.spec
            artifact-name: sby-ost-tool-macos-streaming
            dist-path: dist/SBY_OST_Tool_Remote.app
            archive-name: SBY_OST_Tool-macos-streaming.zip
    runs-on: ${{ matrix.os }}

    env:
      PIP_DISABLE_PIP_VERSION_CHECK: '1'
      PYTHONDONTWRITEBYTECODE: '1'
      SBY_ASSET_MODE: ${{ matrix.mode == 'streaming' && 'remote' || '' }}
      SBY_R2_BASE_URL: ${{ secrets.SBY_R2_BASE_URL }}
      SBY_R2_PREFIX: ${{ secrets.SBY_R2_PREFIX }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: ${{ matrix.mode == 'standalone' }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Install system dependencies (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-dev libgl1-mesa-dev libxkbcommon-x11-0 libpulse-dev libasound2-dev

      - name: Install build tooling
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller pillow

      - name: Generate macOS icon
        if: matrix.os == 'macos-latest'
        run: |
          mkdir -p resources
          python - <<'PY'
          import os
          from pathlib import Path
          from PIL import Image
          ICON_SIZES = [16, 32, 64, 128, 256, 512, 1024]
          iconset = Path('icon.iconset')
          iconset.mkdir(exist_ok=True)
          img = Image.open('icon.ico')
          for size in ICON_SIZES:
              resized = img.resize((size, size))
              resized.save(iconset / f'icon_{size}x{size}.png')
              if size < 512:
                  resized2 = img.resize((size * 2, size * 2))
                  resized2.save(iconset / f'icon_{size}x{size}@2x.png')
          PY
          iconutil -c icns icon.iconset
          mv icon.icns . || cp icon.icns .

      - name: Write runtime config
        shell: python
        env:
          BUILD_MODE: ${{ matrix.mode }}
          R2_BASE_URL: ${{ secrets.SBY_R2_BASE_URL }}
          R2_PREFIX: ${{ secrets.SBY_R2_PREFIX }}
        run: |
          import json
          import os
          from pathlib import Path
          config = {}
          if os.environ.get("BUILD_MODE") == "streaming":
              base_url = os.environ.get("R2_BASE_URL", "").strip().strip('"\'')
              prefix = os.environ.get("R2_PREFIX", "").strip().strip('"\'')
              config["asset_mode"] = "remote"
              config["r2_base_url"] = base_url
              config["r2_prefix"] = prefix
          Path("runtime_config.json").write_text(json.dumps(config, indent=2))

      - name: Compile sources
        run: python -m compileall soundtrack_tool rename.py

      - name: Build artifact
        run: pyinstaller ${{ matrix.spec }} --noconfirm

      - name: Cleanup build artifacts (macOS)
        if: matrix.os == 'macos-latest'
        run: rm -rf icon.iconset || true

      - name: Sign macOS app (ad-hoc)
        if: matrix.os == 'macos-latest'
        run: |
          codesign --force --deep --sign - "${{ matrix.dist-path }}"

      - name: Create archive (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          cd dist
          ditto -c -k --sequesterRsrc --keepParent "$(basename ${{ matrix.dist-path }})" "../${{ matrix.archive-name }}"
          cd ..

      - name: Create archive (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          cd dist
          tar -czf "../${{ matrix.archive-name }}" "$(basename ${{ matrix.dist-path }})"
          cd ..

      - name: Create archive (Windows)
        if: startsWith(matrix.os, 'windows')
        shell: pwsh
        run: |
          cd dist
          Compress-Archive -Path "$(Split-Path -Leaf '${{ matrix.dist-path }}')" -DestinationPath "../${{ matrix.archive-name }}"
          cd ..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: ${{ matrix.archive-name }}
          if-no-files-found: error
          overwrite: true
